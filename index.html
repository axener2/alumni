<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alumni Anonymous Thread</title>
<meta name="description" content="Temporary, anonymous, one-thread wall." />
<style>
  :root{
    --bg:#0b1020; --panel:#0f162a; --panel-2:#121a31; --text:#e6ebf4; --muted:#9aacbf;
    --brand:#22d3ee; --brand-2:#14b8a6; --danger:#ef4444; --ring:#2dd4bf;
    --glow:0 10px 30px rgba(34,211,238,.12), inset 0 1px 0 rgba(255,255,255,.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); background: radial-gradient(1000px 600px at 20% -10%, #11214a 0%, #0b1020 40%) no-repeat fixed, var(--bg);
    font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue";
  }
  .shell{min-height:100%; display:flex; flex-direction:column}
  .wrap{width:100%; max-width:860px; margin:0 auto; padding:22px 16px 92px}
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px;
  }
  .brand{
    display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px;
  }
  .dot{width:10px; height:10px; border-radius:50%; background:radial-gradient(circle at 30% 30%, #7df9ff, #22d3ee 60%, #0ea5b3); box-shadow:0 0 24px #22d3ee88}
  .pill{font-size:12px; color:var(--muted); background: #0d152b; border:1px solid #1b2746; padding:6px 10px; border-radius:999px}
  .actions{display:flex; align-items:center; gap:8px}
  .link{cursor:pointer; color:var(--brand); font-weight:600}
  .link:hover{opacity:.9; text-decoration:underline}
  .panel{
    background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
    border:1px solid #1b2746; border-radius:14px; box-shadow:var(--glow);
  }
  .composer{ padding:14px }
  textarea{
    width:100%; min-height:110px; resize:vertical;
    border:1px solid #213055; background:#0a1226; color:var(--text);
    border-radius:12px; padding:12px 14px; outline:none; transition:border-color .15s, box-shadow .15s;
  }
  textarea:focus{ border-color:#2e436f; box-shadow:0 0 0 3px #2dd4bf22; }
  .row{display:flex; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap}
  .btn{
    appearance:none; border:0; cursor:pointer; font-weight:700;
    background: linear-gradient(180deg, var(--brand) 0%, var(--brand-2) 100%);
    color:#002e2e; padding:10px 14px; border-radius:12px; box-shadow:0 6px 18px rgba(34,211,238,.18);
    transition: transform .06s ease, box-shadow .15s ease, filter .2s;
  }
  .btn:active{ transform:translateY(1px); filter:saturate(.92) }
  .btn[disabled]{opacity:.6; cursor:not-allowed; filter:grayscale(.2)}
  .meta{display:flex; align-items:center; gap:12px; margin-left:auto; color:var(--muted); font-size:12px}
  .count{min-width:66px; text-align:right}
  .status.error{ color:var(--danger) }

  .list{ margin-top:18px; display:flex; flex-direction:column; gap:12px }
  .card{
    background:linear-gradient(180deg, #0c142a 0%, #0a1226 100%);
    border:1px solid #1b2746; border-radius:14px; padding:14px 14px 10px; box-shadow:var(--glow);
    animation:fadeIn .2s ease-out;
  }
  .msg{ white-space:pre-wrap; word-wrap:break-word; }
  .foot{ display:flex; align-items:center; gap:10px; margin-top:8px; color:var(--muted); font-size:12px }
  .del{
    margin-left:auto; background:#121a31; border:1px solid #26355e; color:#e9a3a3;
    padding:6px 10px; border-radius:10px; cursor:pointer; display:none;
  }
  .del:hover{ border-color:#384f84; color:#fecaca }
  @keyframes fadeIn{from{opacity:.0; transform:translateY(4px)} to{opacity:1; transform:none}}
  .empty{
    text-align:center; color:var(--muted); padding:24px; border:1px dashed #26355e; border-radius:14px;
    background: #0c142a55;
  }

  /* Loading shimmer */
  .skeleton{ display:flex; flex-direction:column; gap:12px; }
  .sk{ height:72px; border-radius:14px; background:linear-gradient(90deg, #0f172e 0%, #162042 40%, #0f172e 80%);
       background-size:200% 100%; animation:sh 1.2s infinite ease-in-out; border:1px solid #1b2746 }
  @keyframes sh{ 0%{background-position:0% 0} 100%{background-position:200% 0} }

  .footer{ text-align:center; color:var(--muted); margin:22px 0 26px; font-size:12px }
  .sticky{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg, #0b1020cc, #0b1020 70%); border-top:1px solid #1b2746 }
  .sticky .composer{ padding:10px 16px }
  @media (min-width:900px){ .sticky{position:static; background:none; border:0} }
</style>
</head>
<body>
<div class="shell">
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><span class="dot"></span> Alumni Anonymous Thread</div>
      <div class="actions">
        <span id="adminToggle" class="link">Admin</span>
        <span class="pill">Live</span>
      </div>
    </div>

    <!-- Composer (sticky on small screens) -->
    <div class="panel sticky">
      <div class="composer">
        <textarea id="message" maxlength="2000" placeholder="Write your message… (no names/contacts/photos)"></textarea>
        <div class="row">
          <button id="postBtn" class="btn">Post Anonymously</button>
          <span id="status" class="status muted" aria-live="polite"></span>
          <div class="meta">
            <span id="charCount" class="count">0/2000</span>
          </div>
        </div>
      </div>
    </div>

    <div id="skeleton" class="skeleton" aria-hidden="true">
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
    </div>

    <div id="list" class="list" hidden></div>
    <div id="empty" class="empty" hidden>No messages yet. Be the first to post.</div>

    <div class="footer">Shows only the last 4 hours • Please be respectful</div>
  </div>
</div>

<!-- Firebase v12 (modular) -->
<script type="module">
  /* ====== CONFIG (your project) ====== */
  const firebaseConfig = {
    apiKey: "AIzaSyArKL5zbf7aRd8wzbUae6xWbO0Slw6Yc3U",
    authDomain: "alumnichat-a0b1f.firebaseapp.com",
    databaseURL: "https://alumnichat-a0b1f-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "alumnichat-a0b1f",
    storageBucket: "alumnichat-a0b1f.firebasestorage.app",
    messagingSenderId: "106010343058",
    appId: "1:106010343058:web:ea9ada621c7316f718184b",
    measurementId: "G-YEVPB69BT0"
  };

  /* ====== Imports ====== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import {
    getDatabase, ref, push, serverTimestamp,
    query, orderByChild, startAt, onChildAdded, onChildRemoved, remove
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  /* ====== Init ====== */
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const THREAD = "anonThread/messages";

  /* ====== State ====== */
  let adminMode = false;
  const ADMIN_PIN = "4320"; // <— your new PIN
  const seen = new Set();
  const nodes = new Map();  // key -> DOM node
  let firstRenderDone = false;

  /* ====== UI helpers ====== */
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const skEl = document.getElementById('skeleton');
  const statusEl = document.getElementById('status');
  const msgEl = document.getElementById('message');
  const postBtn = document.getElementById('postBtn');
  const charCount = document.getElementById('charCount');

  const note = (t, err=false) => { statusEl.textContent = t || ''; statusEl.className = 'status ' + (err ? 'error' : 'muted'); };
  const showList = () => { skEl.hidden = true; listEl.hidden = false; };

  msgEl.addEventListener('input', () => {
    charCount.textContent = `${msgEl.value.length}/2000`;
  });

  document.getElementById('adminToggle').addEventListener('click', () => {
    if (adminMode) {
      adminMode = false;
      renderAdminButtons();
      return;
    }
    const pin = prompt('Enter admin PIN:');
    adminMode = (pin === ADMIN_PIN);
    renderAdminButtons();
    if (!adminMode && pin) alert('Wrong PIN');
  });

  function renderAdminButtons() {
    document.querySelectorAll('.del').forEach(b => {
      b.style.display = adminMode ? 'inline-block' : 'none';
    });
  }

  function fmt(ts){ return new Date(ts || Date.now()).toLocaleString(); }

  /* ====== Render a message card (prepend: newest on top) ====== */
  function renderCard(key, message, ts) {
    if (seen.has(key)) return;
    seen.add(key);

    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.key = key;

    const m = document.createElement('div');
    m.className = 'msg';
    m.textContent = message;

    const foot = document.createElement('div');
    foot.className = 'foot';

    const time = document.createElement('div');
    time.textContent = fmt(ts);
    time.className = 'ts';

    const del = document.createElement('button');
    del.className = 'del';
    del.textContent = 'Delete';
    del.style.display = adminMode ? 'inline-block' : 'none';
    del.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!confirm('Delete this message?')) return;
      try {
        await remove(ref(db, `${THREAD}/${key}`));
      } catch {
        alert('Delete failed.');
      }
    });

    foot.appendChild(time);
    foot.appendChild(del);

    card.appendChild(m);
    card.appendChild(foot);

    // PREPEND (newest first)
    if (listEl.firstChild) listEl.insertBefore(card, listEl.firstChild);
    else listEl.appendChild(card);

    nodes.set(key, card);
    renderAdminButtons();
  }

  /* ====== Subscribe (last 4 hours) ====== */
  const FOUR_HOURS_MS = 4 * 60 * 60 * 1000;

  function subscribe() {
    listEl.innerHTML = '';
    seen.clear(); nodes.clear(); firstRenderDone = false;
    const since = Date.now() - FOUR_HOURS_MS;
    const q = query(ref(db, THREAD), orderByChild('ts'), startAt(since));

    onChildAdded(q, (snap) => {
      const v = snap.val();
      const key = snap.key;
      if (!v || !v.message) return;
      renderCard(key, v.message, v.ts || Date.now());

      if (!firstRenderDone) { // first batch: reveal list once a couple have arrived or after small delay
        showList();
        firstRenderDone = true;
        // Show “empty” if nothing else arrives
        setTimeout(() => { if (listEl.childElementCount === 0) { emptyEl.hidden = false; } }, 250);
      }
    });

    // Also handle deletions
    onChildRemoved(ref(db, THREAD), (snap) => {
      const key = snap.key;
      const node = nodes.get(key);
      if (node && node.parentNode) node.parentNode.removeChild(node);
      nodes.delete(key);
      seen.delete(key);
      if (listEl.childElementCount === 0) emptyEl.hidden = false;
    });

    // Fallback: if no messages at all after short delay, show empty
    setTimeout(() => {
      showList();
      if (listEl.childElementCount === 0) emptyEl.hidden = false;
    }, 500);
  }

  /* ====== Post ====== */
  postBtn.addEventListener('click', async () => {
    const message = msgEl.value.trim();
    if (!message) return note('Message is empty.', true);
    if (message.length > 2000) return note('Message too long (2000).', true);

    try {
      postBtn.disabled = true; note('Posting…');
      // NO optimistic append to avoid duplicates; realtime will add within a moment
      await push(ref(db, THREAD), { message, ts: serverTimestamp() });
      msgEl.value = ''; charCount.textContent = '0/2000';
      note('Posted!');
    } catch {
      note('Error posting.', true);
    } finally {
      postBtn.disabled = false;
      setTimeout(() => note(''), 1200);
    }
  });

  subscribe();
</script>
</body>
</html>