<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Alumni Anonymous Thread</title>
    <style>
      :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--brand:#14b8a6;}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,-apple-system}
      .wrap{max-width:720px;margin:24px auto;padding:0 16px}
      h1{font-size:20px;margin:0 0 10px}
      .card{background:var(--panel);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 0 rgba(255,255,255,0.03) inset}
      textarea{width:100%;min-height:96px;border:1px solid #1f2937;background:#0b1220;color:var(--text);border-radius:8px;padding:12px;outline:none}
      button{background:var(--brand);color:#062925;border:0;border-radius:8px;padding:10px 14px;cursor:pointer}
      .muted{color:var(--muted);font-size:12px}
      .msg{white-space:pre-wrap;word-wrap:break-word}
      .ts{font-size:12px;color:var(--muted);margin-top:6px}
      .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
      .footer{margin:18px 0 12px;text-align:center}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <h1>Alumni Anonymous Thread</h1>
        <span class="muted" id="lastSync">Auto refreshing…</span>
      </div>

      <div class="card">
        <textarea id="message" placeholder="Write your message… (no names/contacts/photos)"></textarea>
        <div class="row">
          <button id="postBtn">Post Anonymously</button>
          <span id="status" class="muted"></span>
        </div>
      </div>

      <div id="list"></div>

      <div class="footer muted">This wall auto-refreshes. Be respectful.</div>
    </div>

    <script>
      function note(t){ document.getElementById('status').textContent = t; }
      function setSync(){ document.getElementById('lastSync').textContent = 'Updated ' + new Date().toLocaleTimeString(); }

      function renderList(items){
        const list = document.getElementById('list');
        list.innerHTML = '';
        if(!Array.isArray(items) || items.length===0){
          const empty = document.createElement('div');
          empty.className='muted';
          empty.textContent = 'No messages yet.';
          list.appendChild(empty);
          return;
        }
        items.sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));
        items.forEach(m=>{
          const card = document.createElement('div');
          card.className='card';
          const msg = document.createElement('div');
          msg.className='msg';
          msg.textContent = m.message;
          const ts = document.createElement('div');
          ts.className='ts';
          ts.textContent = new Date(m.timestamp).toLocaleString();
          card.appendChild(msg);
          card.appendChild(ts);
          list.appendChild(card);
        });
      }

      function load(){
        google.script.run
          .withSuccessHandler(items => { renderList(items||[]); setSync(); })
          .getMessages();
      }

      document.getElementById('postBtn').addEventListener('click', () => {
        const el = document.getElementById('message');
        const message = el.value.trim();
        if(!message){ return note('Message is empty.'); }
        if(message.length > 2000){ return note('Message too long (2000).'); }
        note('Posting…');

        // Show instantly (optimistic append)
        const list = document.getElementById('list');
        if(list.children.length === 1 && list.children[0].classList.contains('muted')){ list.innerHTML=''; }
        const card = document.createElement('div');
        card.className = 'card';
        const msg = document.createElement('div');
        msg.className = 'msg';
        msg.textContent = message;
        const ts = document.createElement('div');
        ts.className = 'ts';
        ts.textContent = 'Just now…';
        card.appendChild(msg);
        card.appendChild(ts);
        list.appendChild(card);
        el.value = '';

        // Send to server (same origin)
        google.script.run
          .withSuccessHandler(() => { note('Posted!'); load(); })
          .withFailureHandler(err => { note('Failed: ' + (err?.message || 'error')); })
          .postMessage(message);
      });

      load();                   // initial
      setInterval(load, 6000);  // auto-refresh
    </script>
  </body>
</html>