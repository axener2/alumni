<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Alumni Anonymous Thread</title>
    <style>
      :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8;--brand:#14b8a6;--err:#f87171;}
      *{box-sizing:border-box}
      body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,-apple-system}
      .wrap{max-width:720px;margin:24px auto;padding:0 16px}
      h1{font-size:20px;margin:0 0 10px}
      .card{background:var(--panel);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 0 rgba(255,255,255,0.03) inset}
      textarea{width:100%;min-height:96px;border:1px solid #1f2937;background:#0b1220;color:var(--text);border-radius:8px;padding:12px;outline:none}
      button{background:var(--brand);color:#062925;border:0;border-radius:8px;padding:10px 14px;cursor:pointer}
      .muted{color:var(--muted);font-size:12px}
      .error{color:var(--err)}
      .msg{white-space:pre-wrap;word-wrap:break-word}
      .ts{font-size:12px;color:var(--muted);margin-top:6px}
      .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
      .footer{margin:18px 0 12px;text-align:center}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <h1>Alumni Anonymous Thread</h1>
        <span class="muted" id="lastSync">Auto refreshing…</span>
      </div>

      <div class="card">
        <textarea id="message" placeholder="Write your message… (no names/contacts/photos)"></textarea>
        <div class="row">
          <button id="postBtn">Post Anonymously</button>
          <span id="status" class="muted"></span>
        </div>
      </div>

      <div id="list"></div>

      <div class="footer muted">This wall auto-refreshes. Be respectful.</div>
    </div>

    <script>
      const API = "https://script.google.com/macros/s/AKfycby3IxJB11gomfsA2MQ-BFM3bJuesbhv7SQLBI-RHOpxZmOb0W5U6qkq8ddpmIqVTh4mow/exec";

      function note(t, isErr=false){
        const s = document.getElementById('status');
        s.textContent = t || '';
        s.className = isErr ? 'error' : 'muted';
      }
      function setSync(){ document.getElementById('lastSync').textContent = 'Updated ' + new Date().toLocaleTimeString(); }

      function renderList(items){
        const list = document.getElementById('list');
        list.innerHTML = '';
        if(!Array.isArray(items) || items.length===0){
          const empty = document.createElement('div');
          empty.className='muted';
          empty.textContent = 'No messages yet.';
          list.appendChild(empty);
          return;
        }
        items.sort((a,b)=> new Date(a.timestamp) - new Date(b.timestamp));
        items.forEach(m=>{
          const card = document.createElement('div');
          card.className='card';
          const msg = document.createElement('div');
          msg.className='msg';
          msg.textContent = m.message;
          const ts = document.createElement('div');
          ts.className='ts';
          ts.textContent = new Date(m.timestamp).toLocaleString();
          card.appendChild(msg);
          card.appendChild(ts);
          list.appendChild(card);
        });
      }

      async function load(){
        try{
          const res = await fetch(API + "?action=get");
          const data = await res.json();
          if(data && data.ok){ renderList(data.data); setSync(); }
          else{ note('Load failed', true); }
        }catch(e){ note('Load error', true); }
      }

      document.getElementById('postBtn').addEventListener('click', async () => {
        const el = document.getElementById('message');
        const message = el.value.trim();
        if(!message){ return note('Message is empty.', true); }
        if(message.length > 2000){ return note('Message too long (2000).', true); }
        note('Posting…');

        // Optimistic append
        const list = document.getElementById('list');
        if(list.children.length === 1 && list.children[0].classList.contains('muted')){ list.innerHTML=''; }
        const card = document.createElement('div');
        card.className = 'card';
        const msg = document.createElement('div');
        msg.className = 'msg';
        msg.textContent = message;
        const ts = document.createElement('div');
        ts.className = 'ts';
        ts.textContent = 'Just now…';
        card.appendChild(msg);
        card.appendChild(ts);
        list.appendChild(card);
        el.value = '';

        try{
          const res = await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "action=post&message=" + encodeURIComponent(message)
          });
          const data = await res.json();
          if(data.ok){ note('Posted!'); load(); }
          else{ note('Failed to post', true); }
        }catch(e){ note('Error posting', true); }
      });

      load();                   // initial
      setInterval(load, 6000);  // auto-refresh
    </script>
  </body>
</html>